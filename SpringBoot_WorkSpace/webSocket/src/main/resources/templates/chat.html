<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
<title>CHAT</title>
<style type="text/css">
	#chatBox{
	    width: 500px;
		height: 700px;
		overflow-y: auto;
		background-color: lightgray;
		padding: 10px;
	}
	.msgContent{
		display: inline-block;
		padding: 5px;
		border-radius: 10px;
	}
	.reciveMsg .msgContent{
		background-color: white;
	}
	.sendMsg .msgContent{
		background-color: yellow;
	}
	.sendMsg{
		margin-top: 10px;
        text-align: end;
    }
    .reciveMsg{
    	margin-top: 8px;
    }
    #span{
    	font-size: 8px;
    }
    .inoutMsg{
        display: inline-block;
        padding: 10px 15px;
        color: white;
        background-color: gray;
        font-size: 12px;
        border-radius: 10px;
    }
    .img{
    	max-width: 200px;
    	max-height: 200px;
    	border-radius: 10px;
    }
</style>
</head>
<body>
	
	<div class="container mx-auto mt-5">
		<div class="rounded-4" id="chatBox">
			<div class="text-center my-2">
				<div class="inoutMsg">
					닉네임 이/가 (입장/퇴장)했습니다.
				</div>
			</div>
			<!-- 받은 메시지 -->
			<div class="reciveMsg">
				<div>닉네임</div>
				<div>
					<div class="msgContent">메시지 내용</div>
					<span class="mb-auto">시간</span>
				</div>
			</div>
			
			<!-- 내가 보낸 메시지 -->
			<div class="sendMsg">
				<div>
					<span class="mb-auto">시간</span>
					<div class="msgContent">메시지 내용</div>
				</div>
			</div>
			
			<div th:each="msg : ${messageList}">
				<div th:if="${msg.type == 'inout'}" class="text-center my-2">
					<div class="inoutMsg" th:text="${msg.sender} + '님이' + ${msg.content} + '했습니다.'">
					</div>
				</div>
			<!-- 받은 메시지 -->
				<div th:if="${msg.type == 'message' and msg.sender != session.username}" class="reciveMsg">
					<div th:text="${msg.sender}"></div>
					<div>
						<div class="msgContent" th:text="${msg.content}">메시지 내용</div>
						<span class="mb-auto" th:text="${msg.msgTime}">시간</span>
					</div>
				</div>
				
			<!-- 받은 이미지 -->
				<div th:if="${msg.type == 'image' and msg.sender != session.username}" class="reciveMsg">
					<div th:text="${msg.sender}"></div>
					<div>
						<div class="msgContent"><img class="img" th:src="${msg.content}"></div>
						<span class="msgTime" th:text="${msg.msgTime}"></span>
					</div>
				</div>
				
			
			<!-- 내가 보낸 메시지 -->
				<div th:if="${msg.type == 'message' and msg.sender == session.username}" class="sendMsg">
					<div>
						<span class="mb-auto" th:text="${msg.msgTime}">시간</span>
						<div class="msgContent" th:text="${msg.content}">메시지 내용</div>
					</div>
				</div>
				
				<!-- 받은 이미지 -->
				<div th:if="${msg.type == 'image' and msg.sender == session.username}" class="sendMsg">
					<div>
					<span class="msgTime" th:text="${msg.msgTime}"></span>
						<div class="msgContent"><img class="img" th:src="${msg.content}"></div>
					</div>
				</div>
				
			</div>
		</div>
		
		
		<div class="input-group mb-3" style="width: 500px;">
			<input type="text" class="form-control" id="inputText">
			<button class="btn btn-outline-secondary" type="button" id="sendBtn" onclick="sendMessage()">전송</button>
			<button class="btn btn-outline-secondary" type="button" id="fileBtn">이미지</button>
		</div>
			<input type="file" class="d-none" id="imgFile">
			<div class="col-4">
				<div class="card">
					<div class="card-header">
					  접속자 목록
					</div>
					<div class="card-body p-0">
						<div class="list-group" id="connectUserList">
						  <!-- <div class="list-group-item">접속자 아이디</div> -->

						</div>
					</div>
				</div>			
			</div>
	</div>
	
	

<!-- jquery -->	
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script type="text/javascript" src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>	
<script type="text/javascript" src="/webjars/stomp-websocket/2.3.4/stomp.js"></script>
<script type="text/javascript">
	
	let username = "[[${session.username}]]";
/* WebSocket에 연결 (접속요청) */
	
	const chatSocket = new SockJS("/ws-chatin");
	const chatClient = Stomp.over(chatSocket);
	
	chatClient.connect({}, function(frame){
		console.log("chatSocket 연결 확인");
		console.log(frame);
		chatBox.scrollTop = chatBox.scrollHeight;
		/* 서버에서 전송되는 메시지의 종류 구분 (구독) */
		chatClient.subscribe("/ServerToClient/publicMsg", function(msg){
			console.log("/serverToClient/publicMsg 구독"); 
			showMsg(msg.body);
		});
		
		chatClient.subscribe("/ServerToClient/ChatInOut", function(msg){
			console.log("/ServerToClient/ChatInOut 구독");
			inOutMsg(msg.body);
		});
		
		chatClient.subscribe('/ServerToClient/userList', function(msg) {
			// 접속자 목록 구독
			console.log(msg.body);
			showUserList(msg.body);
		});	
		
		chatClient.subscribe('/ServerToClient/resList/'+username, function(msg) {
			console.log("/ServerToClient/resList 구독");
			showUserList(msg.body);
		});	
		
		chatClient.subscribe("/ServerToClient/ChatImage", function(msg){
			console.log("/ServerToClient/ChatImage 구독");
			showImage(msg.body);
		});
		
		chatClient.send('/ClientToServer/reqList', {} ,username);
	});
	

/* 클라이언트에서 서버에게 메시지를 전송하는 기능 */
	const inputEl = document.getElementById("inputText");
	function sendMessage(){
		const msgObject = { "type" : "message", "content" : inputEl.value, "sender" : username }; // "파라미터이름" : "파라미터값"
		// input 태그에 입력한 값을 WebSocket 서버에 전송
		chatClient.send("/ClientToServer/chatMsg", // 서버에 보내는 주소
				{},
				JSON.stringify(msgObject)); // 보내는 메시지 object >> JSON 형태의 String
	}
	/* 서버에서 받은 메시지를 출력하는 기능 */
	const chatBoxEl = document.getElementById("chatBox"); // 채팅 출력 박스 선택
	function showMsg(msg){ // 메시지 출력
		let msgObj = JSON.parse(msg); // JSON 형태의 String을 Object로 변환
		if(msgObj.sender == username){
		chatBoxEl.innerHTML += `<div class="sendMsg">
			<div>
			<span class="msgTime">${msgObj.msgTime}</span>
			<div class="msgContent">${msgObj.content}</div>
		</div>
	</div>`;
		}else {
		chatBoxEl.innerHTML += `<div class="reciveMsg">
			<div>${msgObj.sender}</div>
			<div>
				<div class="msgContent">${msgObj.content}</div>
				<span class="msgTime">${msgObj.msgTime}</span>
			</div>
		</div>`;
		}
		
		inputEl.value = ""; // 메시지 전송 후 input 태그 초기화
		chatBox.scrollTop = chatBox.scrollHeight;
		
	}
	
	function inOutMsg(msg){
		console.log(msg);
		let msgObj = JSON.parse(msg);
		chatBoxEl.innerHTML += `<div class="text-center my-2">
				<div class="inoutMsg">
			 		${msgObj.sender} 님이 ${msgObj.content}했습니다.
				</div>
			</div>`;
		chatBox.scrollTop = chatBox.scrollHeight;
	}
	
	const connectUserListEl = document.getElementById('connectUserList');
	function showUserList(msg){
		let msgObj = JSON.parse(msg);
		connectUserListEl.innerHTML = ''; // 목록 초기화
		for(let user of msgObj){
			connectUserListEl.innerHTML += `<div class="list-group-item">${user}</div>`;
		}
	}
	
	function showImage(msg){
		let msgObj = JSON.parse(msg); // JSON 형태의 String을 Object로 변환
		if(msgObj.sender == username){
		chatBoxEl.innerHTML += `<div class="sendMsg">
			<div>
			<span class="msgTime">${msgObj.msgTime}</span>
			<div class="msgContent"><img class="img" src=${msgObj.content}></div>
		</div>
	</div>`;
		}else {
		chatBoxEl.innerHTML += `<div class="reciveMsg">
			<div>${msgObj.sender}</div>
			<div>
				<div class="msgContent"><img class="img" src=${msgObj.content}></div>
				<span class="msgTime">${msgObj.msgTime}</span>
			</div>
		</div>`;
		}
		
		chatBox.scrollTop = chatBox.scrollHeight; // 채팅 박스 스크롤을 맨 아래로 이동
	}
	
	// 파일 태그 선택
	const imgFileEl = document.getElementById("imgFile");
	document.getElementById("fileBtn").addEventListener("click", function(){
		imgFileEl.click();
	});
	// 이미지를 선택한 후 전송 이벤트
	imgFileEl.addEventListener("change", function(){
		console.log(imgFileEl.value);
		const selectFile = imgFileEl.files[0];
		// 1. 이미지를 서버에 업로드 (ajax 이용) >> 이미지가 저장된 경로 응답
		const formData = new FormData();
		formData.append("imgFile", selectFile); // FormData에 파일 추가
		$.ajax({
			url: "/img",
			type: "POST",
			data: formData, // data 값으로 미리 만들어둔 formData 사용
			processData: false, // data 변환 처리 사용 x
			contentType: false, // 형식 변환 처리 사용 x
			success: function(res){
				let msgObject = { "type" : "image", "content" : res, "sender" : username }; // "파라미터이름" : "파라미터값"
				// input 태그에 입력한 값을 WebSocket 서버에 전송
				chatClient.send("/ClientToServer/ChatImage", // 서버에 보내는 주소
								{},
								JSON.stringify(msgObject)); // 보내는 메시지 object >> JSON 형태의 String
			},
		});
		
		
		
	});
	
</script>
</body>
</html>